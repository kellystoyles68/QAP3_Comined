// tests
const request = require("supertest");
const express = require("express");
const { Pool } = require("pg");
const indexRouter = require("../routes/index");

jest.mock("pg", () => {
  const mPool = {
    connect: jest.fn(),
    query: jest.fn(),
    on: jest.fn(),
  };
  return { Pool: jest.fn(() => mPool) };
});

const app = express();
app.use(express.json());
app.use("/", indexRouter);

describe("GET /books", () => {
  it("should list all books", async () => {
    const pool = new Pool();
    pool.query.mockResolvedValue({
      rows: [
        { id: 1, title: "Book 1", author: "Author 1" },
        { id: 2, title: "Book 2", author: "Author 2" },
      ],
    });

    const res = await request(app).get("/books");
    expect(res.statusCode).toEqual(200);
    expect(res.body).toEqual([
      { id: 1, title: "Book 1", author: "Author 1" },
      { id: 2, title: "Book 2", author: "Author 2" },
    ]);
  });
});
